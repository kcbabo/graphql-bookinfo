apiVersion: graphql.gloo.solo.io/v1alpha1
kind: GraphQLSchema
metadata:
  name: bookinfo-graphql
  namespace: gloo-system
spec:
  enableIntrospection: true
  resolutions:
  - matcher:
      fieldMatcher:
        field: productsForHome
        type: Query
    restResolver:
      request:
        headers:
          :method: GET
          :path: /api/v1/products
      upstreamRef:
        name: default-productpage-9080
        namespace: gloo-system
  - matcher:
      fieldMatcher:
        field: detail
        type: Product
    restResolver:
      request:
        headers:
          :method: GET
          :path: "/details/{$parent.id}"
      upstreamRef:
        name:  default-details-9080
        namespace: gloo-system
  - matcher:
      fieldMatcher:
        field: review
        type: Product
    restResolver:
      request:
        headers:
          :method: GET
          :path: "/reviews/{$parent.id}"
      response:
        resultRoot: "reviews"
      upstreamRef:
        name:  default-reviews-9080
        namespace: gloo-system
  - matcher:
      fieldMatcher:
        field: ratings
        type: Product
    restResolver:
      request:
        headers:
          :method: GET
          :path: "/ratings/{$parent.id}"
      response:
        resultRoot: "ratings[*]"
        setters:
          reviewer: "[*][0]"
          numStars: "[*][1]"
      upstreamRef:
        name:  default-ratings-9080
        namespace: gloo-system
  schema: |
    type Query {
      productsForHome: [Product]
    }

    type Product {
      id: String
      title: String
      descriptionHtml: String
      detail : ProductDetail
      review: [Review]
      ratings: [Rating]
    }

    type ProductDetail {
      id: String
      author: String
      pages: Int
      year: Int
    }

    type Review {
      reviewer: String
      text: String
    }

    type Rating {
      reviewer: String
      numStars: Int
    }
